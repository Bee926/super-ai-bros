<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Super AI Bros — Health Quest</title>
  <style>
    :root {
      --panel: rgba(0,0,0,0.72);
      --border: rgba(255,255,255,0.9);
      --shadow: 0 16px 50px rgba(0,0,0,0.45);
    }

    html, body {
      margin: 0;
      height: 100%;
      background: #0b1020;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Center the game nicely on desktop */
    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 24px;
    }

    .stage {
      position: relative;
      width: 800px;
      max-width: calc(100vw - 32px);
      aspect-ratio: 800 / 450;
      box-shadow: var(--shadow);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 14px;
      overflow: hidden;
      background: #111;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
      image-rendering: pixelated;
      background: #5c94fc;
    }

    /* UI overlay layer */
    .ui-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 40;
      background: rgba(0,0,0,0.6);
      text-align: center;
      padding: 18px;
    }

    .hidden { display: none !important; }

    .panel {
      background: rgba(0,0,0,0.8);
      border: 2px solid var(--border);
      padding: 14px 16px;
      max-width: 560px;
    }

    .retro-text {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    h1 {
      margin: 0 0 18px;
      line-height: 1.1;
    }

    .title-big { font-size: 44px; }
    .title-sub { font-size: 22px; color: #ef4444; margin-top: 10px; }

    .btn {
      pointer-events: auto;
      cursor: pointer;
      border: none;
      padding: 14px 18px;
      font-weight: 800;
      border-bottom: 8px solid rgba(0,0,0,0.35);
      transform: translateY(0);
      transition: transform 0.08s ease, border-bottom-width 0.08s ease, filter 0.08s ease;
      border-radius: 10px;
    }
    .btn:active {
      border-bottom-width: 0px;
      transform: translateY(6px);
    }
    .btn-red { background: #dc2626; color: #fff; }
    .btn-red:hover { filter: brightness(1.08); }
    .btn-green { background: #16a34a; color: #fff; }
    .btn-green:hover { filter: brightness(1.08); }
    .btn-yellow { background: #f59e0b; color: #111; padding: 8px 12px; border-bottom: 4px solid rgba(0,0,0,0.35); border-radius: 8px; font-size: 10px; }
    .btn-blue { background: #2563eb; color: #fff; padding: 8px 12px; border-bottom: 4px solid rgba(0,0,0,0.35); border-radius: 8px; font-size: 10px; }

    /* HUD */
    #hud {
      position: absolute;
      inset: 0;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 30;
      pointer-events: none;
    }

    .hud-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 18px;
    }

    .hud-col {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hp-wrap {
      width: 260px;
      max-width: 45vw;
      border: 4px solid #fff;
      height: 22px;
      background: #1f2937;
    }

    #hp-bar {
      height: 100%;
      width: 100%;
      background: #22c55e;
      transition: width 0.25s ease;
    }

    .narrative-center {
      display: flex;
      justify-content: center;
      margin-top: 6px;
    }

    #narrative-box {
      background: rgba(0,0,0,0.6);
      border: 2px solid #fff;
      padding: 10px 12px;
      max-width: 560px;
    }

    #narrative-text {
      margin: 0;
      font-size: 11px;
      line-height: 1.5;
      text-align: center;
      opacity: 0.95;
    }

    /* Mobile helper */
    .hint {
      margin-top: 12px;
      font-size: 12px;
      opacity: 0.85;
      max-width: 520px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="stage">
      <canvas id="gameCanvas" width="800" height="450"></canvas>

      <div id="ui-layer" class="ui-layer">
        <!-- Start Menu -->
        <div id="menu-screen" class="screen">
          <h1 class="retro-text title-big">
            SUPER AI BROS<br/>
            <span class="title-sub">HEALTH QUEST</span>
          </h1>

          <div class="panel retro-text" style="margin-bottom:18px;">
            <div style="font-size:11px; line-height:1.8;">
              - ARROWS / WASD TO MOVE -<br/>
              - SPACE / W / UP TO JUMP -<br/>
              - JUMP ON FOES TO STOMP! -<br/>
              - COINS = HP + POINTS -
            </div>
          </div>

          <button id="start-btn" class="btn btn-red retro-text" style="font-size:18px;">
            PRESS START
          </button>

          <div class="hint">
            Tip: if you’re on a laptop, click the game area first so keys go to the game.
          </div>
        </div>

        <!-- HUD -->
        <div id="hud" class="hidden">
          <div class="hud-top">
            <div class="hud-col">
              <div class="retro-text" style="font-size:14px;">MARIO-AI</div>
              <div id="score-val" class="retro-text" style="font-size:26px;">000000</div>
              <button id="restart-hud-btn" class="btn btn-yellow retro-text" style="width: fit-content;">
                RESTART
              </button>
            </div>

            <div class="hud-col" style="align-items:flex-end;">
              <div id="hp-text" class="retro-text" style="font-size:14px;">HEALTH: 100%</div>
              <div class="hp-wrap">
                <div id="hp-bar"></div>
              </div>
              <button id="ai-reply-btn" class="btn btn-blue retro-text" style="width: fit-content;">
                AI REPLY
              </button>
            </div>
          </div>

          <div class="narrative-center">
            <div id="narrative-box" class="hidden">
              <p id="narrative-text" class="retro-text"></p>
            </div>
          </div>
        </div>

        <!-- Game Over -->
        <div id="gameover-screen" class="screen hidden" style="background: rgba(0,0,0,0.9); z-index:50;">
          <h1 class="retro-text" style="color:#ef4444; font-size:56px; margin-bottom:24px;">
            GAME OVER
          </h1>
          <button id="retry-btn" class="btn btn-green retro-text" style="font-size:22px;">
            RESTART
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Constants
    const CANVAS_WIDTH = 800;
    const CANVAS_HEIGHT = 450;
    const GROUND_Y = 380;
    const GRAVITY = 0.8;
    const JUMP_FORCE = -15;
    const PLAYER_SPEED = 5;
    const SPAWN_RATE_MUSHROOM = 0.01;
    const SPAWN_RATE_COIN = 0.015;
    const INITIAL_HEALTH = 100;
    const COIN_HP_GAIN = 10;
    const MUSHROOM_HP_LOSS = 25;
    const COLORS = {
      sky: '#5c94fc',
      ground: '#885418',
      player: '#ff0000',
      coin: '#ffcc00',
      mushroom: '#8b008b',
    };

    // State
    let gameState = 'MENU';
    let score = 0;
    let health = INITIAL_HEALTH;
    let frame = 0;

    const state = {
      player: {
        x: 100,
        y: GROUND_Y - 40,
        width: 32,
        height: 40,
        vx: 0,
        vy: 0,
        isJumping: false
      },
      coins: [],
      mushrooms: [],
      clouds: [],
      keys: {}
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Audio Manager (same as your original)
    class AudioManager {
      constructor() { this.ctx = null; }
      init() {
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (this.ctx.state === 'suspended') this.ctx.resume();
      }
      createGain(start, duration) {
        if (!this.ctx) return null;
        const gain = this.ctx.createGain();
        gain.gain.setValueAtTime(start, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        gain.connect(this.ctx.destination);
        return gain;
      }
      playJump() {
        this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.createGain(0.1, 0.15);
        osc.type = 'square';
        osc.frequency.setValueAtTime(200, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(600, this.ctx.currentTime + 0.1);
        osc.connect(gain); osc.start(); osc.stop(this.ctx.currentTime + 0.15);
      }
      playCoin() {
        this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.createGain(0.1, 0.2);
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(987.77, this.ctx.currentTime);
        osc.frequency.setValueAtTime(1318.51, this.ctx.currentTime + 0.07);
        osc.connect(gain); osc.start(); osc.stop(this.ctx.currentTime + 0.2);
      }
      playStomp() {
        this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.createGain(0.15, 0.1);
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, this.ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(50, this.ctx.currentTime + 0.1);
        osc.connect(gain); osc.start(); osc.stop(this.ctx.currentTime + 0.1);
      }
      playHit() {
        this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.createGain(0.2, 0.3);
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(150, this.ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(40, this.ctx.currentTime + 0.2);
        osc.connect(gain); osc.start(); osc.stop(this.ctx.currentTime + 0.3);
      }
      playGameOver() {
        this.init();
        const playNote = (freq, start, dur) => {
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          gain.gain.setValueAtTime(0.1, start);
          gain.gain.linearRampToValueAtTime(0, start + dur);
          osc.type = 'square';
          osc.frequency.setValueAtTime(freq, start);
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start(start);
          osc.stop(start + dur);
        };
        const now = this.ctx.currentTime;
        playNote(392.00, now, 0.2);
        playNote(349.23, now + 0.2, 0.2);
        playNote(329.63, now + 0.4, 0.2);
        playNote(261.63, now + 0.6, 0.6);
      }
    }
    const audio = new AudioManager();

    // Offline “AI Narrator” (safe for GitHub Pages)
    const offlineLines = {
      start: [
        "PRESS START. BECOME LEGEND.",
        "WELCOME, HERO. EAT COINS. DODGE PAIN.",
        "SYSTEM ONLINE. HEALTH QUEST INITIATED."
      ],
      hurt: [
        "OW. THAT MUSHROOM IS NOT FRIEND-SHAPED.",
        "POISON DETECTED. SKILL ISSUE? MAYBE.",
        "YOU TOUCHED THE BAD PIXELS. RUN!"
      ],
      heal: [
        "COIN ACQUIRED. HP RESTORED. VIBES UP.",
        "SHINY! HEALTH BOOSTED. KEEP GOING.",
        "YOU’RE RICH (IN COINS)."
      ],
      gameover: [
        "GAME OVER. TRY TOUCHING FEWER MUSHROOMS.",
        "YOU HAVE DIED. BUT LIKE… WITH STYLE.",
        "RESET? THE ARENA DEMANDS A REMATCH."
      ]
    };

    function showNarrative(text) {
      const box = document.getElementById('narrative-box');
      const txt = document.getElementById('narrative-text');
      txt.innerText = text;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 4500);
    }

    function pick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function updateNarrative(type) {
      // Offline mode (no key required)
      const line = pick(offlineLines[type] || ["READY!"]);
      showNarrative(line);
    }

    function resetGame() {
      audio.init();
      score = 0;
      health = INITIAL_HEALTH;
      frame = 0;
      gameState = 'PLAYING';

      state.player = {
        x: 100,
        y: GROUND_Y - 40,
        width: 32,
        height: 40,
        vx: 0,
        vy: 0,
        isJumping: false
      };
      state.coins = [];
      state.mushrooms = [];
      state.clouds = [];

      document.getElementById('menu-screen').classList.add('hidden');
      document.getElementById('gameover-screen').classList.add('hidden');
      document.getElementById('hud').classList.remove('hidden');

      updateHUD();
      updateNarrative('start');
    }

    function updateHUD() {
      document.getElementById('score-val').innerText = score.toString().padStart(6, '0');
      document.getElementById('hp-text').innerText = `HEALTH: ${Math.max(0, health)}%`;
      const bar = document.getElementById('hp-bar');
      bar.style.width = `${Math.max(0, health)}%`;

      if (health > 50) bar.style.background = '#22c55e';
      else if (health > 25) bar.style.background = '#eab308';
      else bar.style.background = '#ef4444';
    }

    // Input
    window.addEventListener('keydown', (e) => state.keys[e.code] = true);
    window.addEventListener('keyup', (e) => state.keys[e.code] = false);

    document.getElementById('start-btn').onclick = resetGame;
    document.getElementById('retry-btn').onclick = resetGame;
    document.getElementById('restart-hud-btn').onclick = resetGame;
    document.getElementById('ai-reply-btn').onclick = () => {
      audio.init();
      updateNarrative(health < 50 ? 'hurt' : 'heal');
    };

    function loop() {
      if (gameState === 'PLAYING') update();
      draw();
      requestAnimationFrame(loop);
    }

    function update() {
      const { player, mushrooms, coins, clouds, keys } = state;
      frame++;

      // Movement
      if (keys['ArrowLeft'] || keys['KeyA']) player.vx = -PLAYER_SPEED;
      else if (keys['ArrowRight'] || keys['KeyD']) player.vx = PLAYER_SPEED;
      else player.vx = 0;

      if ((keys['Space'] || keys['ArrowUp'] || keys['KeyW']) && !player.isJumping) {
        player.vy = JUMP_FORCE;
        player.isJumping = true;
        audio.playJump();
      }

      player.x += player.vx;
      player.y += player.vy;
      player.vy += GRAVITY;

      // Bounds
      if (player.x < 0) player.x = 0;
      if (player.x > CANVAS_WIDTH - player.width) player.x = CANVAS_WIDTH - player.width;
      if (player.y > GROUND_Y - player.height) {
        player.y = GROUND_Y - player.height;
        player.vy = 0;
        player.isJumping = false;
      }

      // Spawning
      if (Math.random() < SPAWN_RATE_MUSHROOM) {
        mushrooms.push({
          x: CANVAS_WIDTH,
          y: GROUND_Y - 32,
          width: 32,
          height: 32,
          vx: -(2 + Math.random() * 3),
          active: true
        });
      }
      if (Math.random() < SPAWN_RATE_COIN) {
        coins.push({
          x: CANVAS_WIDTH,
          y: GROUND_Y - 50 - Math.random() * 100,
          width: 24,
          height: 24,
          active: true
        });
      }
      if (frame % 100 === 0) {
        clouds.push({ x: CANVAS_WIDTH, y: Math.random() * 150, speed: 0.5 + Math.random() });
      }

      // Mushrooms
      state.mushrooms = mushrooms.filter(m => {
        m.x += m.vx;
        if (m.active && player.x < m.x + m.width && player.x + player.width > m.x &&
            player.y < m.y + m.height && player.y + player.height > m.y) {

          const isStomp = player.vy > 0 && (player.y + player.height) < (m.y + m.height * 0.7);

          if (isStomp) {
            m.active = false;
            player.vy = JUMP_FORCE * 0.7;
            score += 500;
            audio.playStomp();
            updateHUD();
            return false;
          } else {
            m.active = false;
            health -= MUSHROOM_HP_LOSS;
            audio.playHit();
            updateHUD();
            updateNarrative('hurt
